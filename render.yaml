# Configura√ß√£o do Render para EnsinaLab Content Engine
# Este arquivo diz ao Render como rodar sua aplica√ß√£o

services:
  # ============================================================================
  # SERVI√áO 1: API FastAPI (o servidor principal)
  # ============================================================================
  - type: web
    name: ensinalab-api
    runtime: python
    plan: free  # Plano gr√°tis! üéâ
    
    # Comando para instalar depend√™ncias
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    
    # Comando para iniciar a API
    startCommand: uvicorn src.main:app --host 0.0.0.0 --port $PORT
    
    # Vari√°veis de ambiente (configura√ß√µes)
    envVars:
      - key: PYTHON_VERSION
        value: "3.9.16"
      
      - key: OPENAI_API_KEY
        sync: false  # Voc√™ vai adicionar isso manualmente no painel
      
      - key: OPENAI_MODEL
        value: "gpt-3.5-turbo"  # Modelo mais barato
      
      - key: DATABASE_URL
        fromDatabase:
          name: ensinalab-db
          property: connectionString  # Pega a URL do banco automaticamente
      
      - key: REDIS_URL
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString  # Pega a URL do Redis automaticamente
      
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString
      
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString
    
    # Verifica√ß√£o de sa√∫de (Render testa se a API est√° funcionando)
    healthCheckPath: /health
    
    # Auto-deploy quando voc√™ fizer push no GitHub
    autoDeploy: true

  # ============================================================================
  # SERVI√áO 2: Celery Worker (processa v√≠deos em background)
  # ============================================================================
  - type: worker
    name: ensinalab-worker
    runtime: python
    plan: free  # Tamb√©m gr√°tis! üéâ
    
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    
    # Comando para iniciar o worker
    startCommand: celery -A src.workers.celery_config worker --loglevel=info --concurrency=2
    
    envVars:
      - key: PYTHON_VERSION
        value: "3.9.16"
      
      - key: OPENAI_API_KEY
        sync: false
      
      - key: OPENAI_MODEL
        value: "gpt-3.5-turbo"
      
      - key: DATABASE_URL
        fromDatabase:
          name: ensinalab-db
          property: connectionString
      
      - key: REDIS_URL
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString
      
      - key: CELERY_BROKER_URL
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString
      
      - key: CELERY_RESULT_BACKEND
        fromService:
          type: redis
          name: ensinalab-redis
          property: connectionString
    
    autoDeploy: true

# ==============================================================================
# BANCO DE DADOS: PostgreSQL
# ==============================================================================
databases:
  - name: ensinalab-db
    databaseName: ensinalab_content
    plan: free  # Gr√°tis por 90 dias, depois $7/m√™s
    
    # Script para criar tabelas automaticamente ap√≥s criar o banco
    postCreateCommand: |
      apt-get update && apt-get install -y python3-pip
      pip3 install -r requirements.txt
      python3 scripts/create_tables.py

# ==============================================================================
# REDIS: Cache e fila de mensagens
# ==============================================================================
services:
  - type: redis
    name: ensinalab-redis
    plan: free  # 25MB gr√°tis (suficiente para come√ßar)
    maxmemoryPolicy: allkeys-lru  # Remove itens antigos quando encher
    ipAllowList: []  # Permite acesso de qualquer lugar (seguro no Render)
